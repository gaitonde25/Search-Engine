b'This is the hard version of this problem. The only difference is the limit of nn - the length of the input string. In this version, 1\xe2\x89\xa4n\xe2\x89\xa41061\xe2\x89\xa4n\xe2\x89\xa4106.'
b"Let's define a correct bracket sequence and its depth as follow:"
b'  An empty string is a correct bracket sequence with depth 00.  If "s" is a correct bracket sequence with depth dd then "(s)" is a correct bracket sequence with depth d+1d+1.  If "s" and "t" are both correct bracket sequences then their concatenation "st" is a correct bracket sequence with depth equal to the maximum depth of ss and tt. '
b'For a (not necessarily correct) bracket sequence ss, we define its depth as the maximum depth of any correct bracket sequence induced by removing some characters from ss (possibly zero). For example: the bracket sequence s=s="())(())" has depth 22, because by removing the third character we obtain a correct bracket sequence "()(())" with depth 22.'
b"Given a string aa consists of only characters '(', ')' and '?'. Consider all (not necessarily correct) bracket sequences obtained by replacing all characters '?' in aa by either '(' or ')'. Calculate the sum of all the depths of all these bracket sequences. As this number can be large, find it modulo 998244353998244353."
b'Hacks in this problem can be done only if easy and hard versions of this problem was solved.'
b'Input'
b"The only line contains a non-empty string consist of only '(', ')' and '?'. The length of the string is at most 106106."
b'Output'
b'Print the answer modulo 998244353998244353 in a single line.'
Tags
combinatorics, probabilities, *2900

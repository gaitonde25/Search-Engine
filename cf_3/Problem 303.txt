b'This is the hard version of the problem. The only difference between the easy and the hard versions are removal queries, they are present only in the hard version.'
b'"Interplanetary Software, Inc." together with "Robots of Cydonia, Ltd." has developed and released robot cats. These electronic pets can meow, catch mice and entertain the owner in various ways.'
b'The developers from "Interplanetary Software, Inc." have recently decided to release a software update for these robots. After the update, the cats must solve the problems about bracket sequences. One of the problems is described below.'
b'  '
b'First, we need to learn a bit of bracket sequence theory. Consider the strings that contain characters "(", ")" and ".". Call a string regular bracket sequence (RBS), if it can be transformed to an empty string by one or more operations of removing either single "." characters, or a continuous substring "()". For instance, the string "(()(.))" is an RBS, as it can be transformed to an empty string with the following sequence of removals:'
b' "(()(.))" \xe2\x86\x92\xe2\x86\x92 "(()())" \xe2\x86\x92\xe2\x86\x92 "(())" \xe2\x86\x92\xe2\x86\x92 "()" \xe2\x86\x92\xe2\x86\x92 "". '
b'We got an empty string, so the initial string was an RBS. At the same time, the string ")(" is not an RBS, as it is not possible to apply such removal operations to it.'
b'An RBS is simple if this RBS is not empty, doesn\'t start with ".", and doesn\'t end with ".".'
b'Denote the substring of the string ss as its sequential subsegment. In particular, s[l\xe2\x80\xa6r]=slsl+1\xe2\x80\xa6srs[l\xe2\x80\xa6r]=slsl+1\xe2\x80\xa6sr, where sisi is the ii-th character of the string ss.'
b'Now, move on to the problem statement itself. You are given a string ss, initially consisting of characters "(" and ")". You need to answer the following queries:'
b'  Given two indices, ll and rr (1\xe2\x89\xa4l<r\xe2\x89\xa4n1\xe2\x89\xa4l<r\xe2\x89\xa4n). It\'s guaranteed that the ll-th character is equal to "(", the rr-th character is equal to ")", and the characters between them are equal to ".". Then the ll-th and the rr-th characters must be set to ".".  Given two indices, ll and rr (1\xe2\x89\xa4l<r\xe2\x89\xa4n1\xe2\x89\xa4l<r\xe2\x89\xa4n), and it\'s guaranteed that the substring s[l\xe2\x80\xa6r]s[l\xe2\x80\xa6r] is a simple RBS. You need to find the number of substrings in s[l\xe2\x80\xa6r]s[l\xe2\x80\xa6r] such that they are simple RBS. In other words, find the number of index pairs ii, jj such that l\xe2\x89\xa4i<j\xe2\x89\xa4rl\xe2\x89\xa4i<j\xe2\x89\xa4r and s[i\xe2\x80\xa6j]s[i\xe2\x80\xa6j] is a simple RBS. '
b'You are an employee in "Interplanetary Software, Inc." and you were given the task to teach the cats to solve the problem above, after the update.'
b'Input'
b'The first line contains two integers nn and qq (2\xe2\x89\xa4n\xe2\x89\xa43\xe2\x8b\x851052\xe2\x89\xa4n\xe2\x89\xa43\xe2\x8b\x85105, 1\xe2\x89\xa4q\xe2\x89\xa43\xe2\x8b\x851051\xe2\x89\xa4q\xe2\x89\xa43\xe2\x8b\x85105), the length of the string, and the number of queries.'
b'The second line contains the string ss, consisting of nn characters "(" and ")".'
b'Each of the following qq lines contains three integers tt, ll and rr (t\xe2\x88\x88{1,2}t\xe2\x88\x88{1,2}, 1\xe2\x89\xa4l<r\xe2\x89\xa4n1\xe2\x89\xa4l<r\xe2\x89\xa4n), the queries you need to answer. It is guaranteed that all the queries are valid and correspond to the problem statements.'
b'Output'
b'For each query, print a single integer in a separate line, the number of substrings that are simple RBS. The answers must be printed in the same order as the queries are specified in the input.'
Tags
binary search, data structures, dfs and similar, graphs, trees, *2800
